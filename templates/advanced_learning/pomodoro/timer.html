{% extends 'base/base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}Pomodoro Timer - Nền Tảng Học Tập{% endblock %}

{% block extra_css %}
<style>
    .timer-display {
        font-size: 4rem;
        font-weight: bold;
        text-align: center;
    }
    
    .timer-controls {
        text-align: center;
        margin-top: 20px;
    }
    
    .timer-controls button {
        margin: 0 10px;
        font-size: 1.2rem;
        padding: 10px 20px;
    }
    
    .timer-phase {
        text-align: center;
        font-size: 1.5rem;
        margin-bottom: 10px;
    }
    
    .pomodoro-counter {
        text-align: center;
        margin-top: 20px;
    }
    
    .pomodoro-counter .tomato {
        color: #dc3545;
        font-size: 1.5rem;
        margin: 0 2px;
    }
    
    .timer-card {
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
    }
    
    .timer-card.work {
        border-top: 5px solid #dc3545;
    }
    
    .timer-card.break {
        border-top: 5px solid #28a745;
    }
    
    .progress {
        height: 10px;
        margin-top: 20px;
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-8">
        <h1 class="mb-3">
            <i class="fas fa-clock text-primary"></i> Pomodoro Timer
        </h1>
        <p class="lead">Học tập hiệu quả với phương pháp Pomodoro - tập trung làm việc trong thời gian ngắn, xen kẽ với các khoảng nghỉ.</p>
    </div>
    <div class="col-md-4 text-end">
        <a href="{% url 'advanced_learning:pomodoro_history' %}" class="btn btn-outline-primary">
            <i class="fas fa-history"></i> Lịch Sử Pomodoro
        </a>
    </div>
</div>

<div class="row">
    <!-- Cài đặt Pomodoro -->
    <div class="col-md-4 mb-4">
        <div class="card h-100">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-cog"></i> Cài Đặt Pomodoro</h5>
            </div>
            <div class="card-body">
                <form id="pomodoro-settings-form">
                    {% csrf_token %}
                    
                    <div class="mb-3">
                        <label for="subject" class="form-label">Chủ đề học tập</label>
                        <select class="form-select" id="subject" name="subject">
                            <option value="">-- Chọn chủ đề --</option>
                            {% for subject in subjects %}
                            <option value="{{ subject.id }}">{{ subject.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="topic" class="form-label">Chủ đề con</label>
                        <select class="form-select" id="topic" name="topic" disabled>
                            <option value="">-- Chọn chủ đề trước --</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="work_duration" class="form-label">Thời gian làm việc (phút)</label>
                        <input type="number" class="form-control" id="work_duration" name="work_duration" min="1" max="60" value="{{ work_duration }}" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="break_duration" class="form-label">Thời gian nghỉ (phút)</label>
                        <input type="number" class="form-control" id="break_duration" name="break_duration" min="1" max="30" value="{{ break_duration }}" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="notes" class="form-label">Ghi chú</label>
                        <textarea class="form-control" id="notes" name="notes" rows="3" placeholder="Nhập mục tiêu học tập của bạn..."></textarea>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Timer -->
    <div class="col-md-8 mb-4">
        <div class="card h-100 timer-card work" id="timer-card">
            <div class="card-body">
                <div class="timer-phase" id="timer-phase">Sẵn sàng bắt đầu</div>
                <div class="timer-display" id="timer-display">25:00</div>
                <div class="progress">
                    <div class="progress-bar bg-danger" id="timer-progress" role="progressbar" style="width: 0%"></div>
                </div>
                <div class="timer-controls mt-4">
                    <button class="btn btn-success" id="start-timer">
                        <i class="fas fa-play"></i> Bắt đầu
                    </button>
                    <button class="btn btn-warning d-none" id="pause-timer">
                        <i class="fas fa-pause"></i> Tạm dừng
                    </button>
                    <button class="btn btn-primary d-none" id="resume-timer">
                        <i class="fas fa-play"></i> Tiếp tục
                    </button>
                    <button class="btn btn-danger" id="reset-timer">
                        <i class="fas fa-redo"></i> Đặt lại
                    </button>
                    <button class="btn btn-secondary" id="skip-timer">
                        <i class="fas fa-forward"></i> Bỏ qua
                    </button>
                </div>
                <div class="pomodoro-counter mt-4">
                    <h5>Pomodoros hoàn thành: <span id="pomodoro-count">0</span></h5>
                    <div id="pomodoro-icons"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Thông tin về phương pháp Pomodoro -->
<div class="row mt-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-info-circle"></i> Về Phương Pháp Pomodoro</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h5>Phương pháp Pomodoro là gì?</h5>
                        <p>Phương pháp Pomodoro là một kỹ thuật quản lý thời gian được phát triển bởi Francesco Cirillo vào cuối những năm 1980. Phương pháp này sử dụng đồng hồ hẹn giờ để chia nhỏ công việc thành các khoảng thời gian, thường là 25 phút, được gọi là "pomodoros", và xen kẽ với các khoảng nghỉ ngắn.</p>
                    </div>
                    <div class="col-md-6">
                        <h5>Các bước cơ bản:</h5>
                        <ol>
                            <li>Quyết định nhiệm vụ cần thực hiện</li>
                            <li>Đặt hẹn giờ Pomodoro (thường là 25 phút)</li>
                            <li>Làm việc cho đến khi hết giờ</li>
                            <li>Nghỉ ngắn (5 phút)</li>
                            <li>Sau mỗi 4 pomodoros, nghỉ dài hơn (15-30 phút)</li>
                        </ol>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-12">
                        <h5>Lợi ích:</h5>
                        <ul>
                            <li>Giảm sự xao nhãng và gián đoạn</li>
                            <li>Tăng khả năng tập trung và chú ý</li>
                            <li>Nâng cao năng suất và hiệu quả</li>
                            <li>Giảm mệt mỏi tinh thần</li>
                            <li>Cải thiện kế hoạch và ước tính thời gian</li>
                            <li>Tạo cảm giác thành tựu và tiến bộ</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Các biến cho timer
        let timerDisplay = document.getElementById('timer-display');
        let timerPhase = document.getElementById('timer-phase');
        let timerCard = document.getElementById('timer-card');
        let timerProgress = document.getElementById('timer-progress');
        let startBtn = document.getElementById('start-timer');
        let pauseBtn = document.getElementById('pause-timer');
        let resumeBtn = document.getElementById('resume-timer');
        let resetBtn = document.getElementById('reset-timer');
        let skipBtn = document.getElementById('skip-timer');
        let pomodoroCount = document.getElementById('pomodoro-count');
        let pomodoroIcons = document.getElementById('pomodoro-icons');
        
        // Biến trạng thái
        let isRunning = false;
        let isPaused = false;
        let isWorkPhase = true;
        let timerInterval;
        let sessionId = null;
        let completedPomodoros = 0;
        let totalSeconds = 0;
        let currentSeconds = 0;
        let workDuration = parseInt(document.getElementById('work_duration').value) * 60;
        let breakDuration = parseInt(document.getElementById('break_duration').value) * 60;
        
        // Âm thanh thông báo
        let alarmSound = new Audio('{% static "sounds/alarm.mp3" %}');
        
        // Cập nhật hiển thị timer
        function updateTimerDisplay() {
            let minutes = Math.floor(currentSeconds / 60);
            let seconds = currentSeconds % 60;
            timerDisplay.textContent = 
                (minutes < 10 ? '0' + minutes : minutes) + ':' +
                (seconds < 10 ? '0' + seconds : seconds);
            
            // Cập nhật thanh tiến trình
            let progressPercent = ((totalSeconds - currentSeconds) / totalSeconds) * 100;
            timerProgress.style.width = progressPercent + '%';
        }
        
        // Bắt đầu timer
        function startTimer() {
            // Lấy giá trị từ form
            workDuration = parseInt(document.getElementById('work_duration').value) * 60;
            breakDuration = parseInt(document.getElementById('break_duration').value) * 60;
            
            // Thiết lập timer
            isWorkPhase = true;
            totalSeconds = workDuration;
            currentSeconds = workDuration;
            
            // Cập nhật giao diện
            timerPhase.textContent = 'Thời gian làm việc';
            timerCard.classList.remove('break');
            timerCard.classList.add('work');
            timerProgress.classList.remove('bg-success');
            timerProgress.classList.add('bg-danger');
            
            updateTimerDisplay();
            
            // Bắt đầu đếm ngược
            isRunning = true;
            isPaused = false;
            
            // Cập nhật nút
            startBtn.classList.add('d-none');
            pauseBtn.classList.remove('d-none');
            resumeBtn.classList.add('d-none');
            
            // Bắt đầu phiên Pomodoro mới
            startPomodoroSession();
            
            // Bắt đầu đếm ngược
            timerInterval = setInterval(function() {
                if (currentSeconds > 0) {
                    currentSeconds--;
                    updateTimerDisplay();
                } else {
                    // Hết thời gian
                    clearInterval(timerInterval);
                    alarmSound.play();
                    
                    if (isWorkPhase) {
                        // Chuyển sang thời gian nghỉ
                        isWorkPhase = false;
                        totalSeconds = breakDuration;
                        currentSeconds = breakDuration;
                        timerPhase.textContent = 'Thời gian nghỉ';
                        timerCard.classList.remove('work');
                        timerCard.classList.add('break');
                        timerProgress.classList.remove('bg-danger');
                        timerProgress.classList.add('bg-success');
                        
                        // Tăng số pomodoro đã hoàn thành
                        completedPomodoros++;
                        pomodoroCount.textContent = completedPomodoros;
                        updatePomodoroIcons();
                    } else {
                        // Chuyển lại thời gian làm việc
                        isWorkPhase = true;
                        totalSeconds = workDuration;
                        currentSeconds = workDuration;
                        timerPhase.textContent = 'Thời gian làm việc';
                        timerCard.classList.remove('break');
                        timerCard.classList.add('work');
                        timerProgress.classList.remove('bg-success');
                        timerProgress.classList.add('bg-danger');
                    }
                    
                    updateTimerDisplay();
                    
                    // Tự động bắt đầu lại timer
                    timerInterval = setInterval(function() {
                        if (currentSeconds > 0) {
                            currentSeconds--;
                            updateTimerDisplay();
                        } else {
                            clearInterval(timerInterval);
                            alarmSound.play();
                            
                            // Lặp lại quy trình
                            if (isWorkPhase) {
                                isWorkPhase = false;
                                totalSeconds = breakDuration;
                                currentSeconds = breakDuration;
                                timerPhase.textContent = 'Thời gian nghỉ';
                                timerCard.classList.remove('work');
                                timerCard.classList.add('break');
                                timerProgress.classList.remove('bg-danger');
                                timerProgress.classList.add('bg-success');
                                
                                completedPomodoros++;
                                pomodoroCount.textContent = completedPomodoros;
                                updatePomodoroIcons();
                            } else {
                                isWorkPhase = true;
                                totalSeconds = workDuration;
                                currentSeconds = workDuration;
                                timerPhase.textContent = 'Thời gian làm việc';
                                timerCard.classList.remove('break');
                                timerCard.classList.add('work');
                                timerProgress.classList.remove('bg-success');
                                timerProgress.classList.add('bg-danger');
                            }
                            
                            updateTimerDisplay();
                            startTimer();
                        }
                    }, 1000);
                }
            }, 1000);
        }
        
        // Tạm dừng timer
        function pauseTimer() {
            if (isRunning && !isPaused) {
                clearInterval(timerInterval);
                isPaused = true;
                pauseBtn.classList.add('d-none');
                resumeBtn.classList.remove('d-none');
            }
        }
        
        // Tiếp tục timer
        function resumeTimer() {
            if (isRunning && isPaused) {
                isPaused = false;
                pauseBtn.classList.remove('d-none');
                resumeBtn.classList.add('d-none');
                
                timerInterval = setInterval(function() {
                    if (currentSeconds > 0) {
                        currentSeconds--;
                        updateTimerDisplay();
                    } else {
                        clearInterval(timerInterval);
                        // Xử lý hết thời gian tương tự như trong startTimer
                    }
                }, 1000);
            }
        }
        
        // Đặt lại timer
        function resetTimer() {
            clearInterval(timerInterval);
            isRunning = false;
            isPaused = false;
            
            // Đặt lại thời gian
            isWorkPhase = true;
            workDuration = parseInt(document.getElementById('work_duration').value) * 60;
            breakDuration = parseInt(document.getElementById('break_duration').value) * 60;
            totalSeconds = workDuration;
            currentSeconds = workDuration;
            
            // Cập nhật giao diện
            timerPhase.textContent = 'Sẵn sàng bắt đầu';
            timerCard.classList.remove('break');
            timerCard.classList.add('work');
            timerProgress.style.width = '0%';
            timerProgress.classList.remove('bg-success');
            timerProgress.classList.add('bg-danger');
            
            // Cập nhật nút
            startBtn.classList.remove('d-none');
            pauseBtn.classList.add('d-none');
            resumeBtn.classList.add('d-none');
            
            updateTimerDisplay();
            
            // Kết thúc phiên hiện tại nếu có
            if (sessionId) {
                endPomodoroSession();
            }
        }
        
        // Bỏ qua giai đoạn hiện tại
        function skipPhase() {
            clearInterval(timerInterval);
            
            if (isWorkPhase) {
                // Chuyển sang thời gian nghỉ
                isWorkPhase = false;
                totalSeconds = breakDuration;
                currentSeconds = breakDuration;
                timerPhase.textContent = 'Thời gian nghỉ';
                timerCard.classList.remove('work');
                timerCard.classList.add('break');
                timerProgress.classList.remove('bg-danger');
                timerProgress.classList.add('bg-success');
                
                // Tăng số pomodoro đã hoàn thành
                completedPomodoros++;
                pomodoroCount.textContent = completedPomodoros;
                updatePomodoroIcons();
            } else {
                // Chuyển lại thời gian làm việc
                isWorkPhase = true;
                totalSeconds = workDuration;
                currentSeconds = workDuration;
                timerPhase.textContent = 'Thời gian làm việc';
                timerCard.classList.remove('break');
                timerCard.classList.add('work');
                timerProgress.classList.remove('bg-success');
                timerProgress.classList.add('bg-danger');
            }
            
            updateTimerDisplay();
            
            // Tiếp tục timer
            if (isRunning && !isPaused) {
                timerInterval = setInterval(function() {
                    if (currentSeconds > 0) {
                        currentSeconds--;
                        updateTimerDisplay();
                    } else {
                        clearInterval(timerInterval);
                        // Xử lý hết thời gian tương tự như trong startTimer
                    }
                }, 1000);
            }
        }
        
        // Cập nhật biểu tượng pomodoro
        function updatePomodoroIcons() {
            pomodoroIcons.innerHTML = '';
            for (let i = 0; i < completedPomodoros; i++) {
                pomodoroIcons.innerHTML += '<i class="fas fa-apple-alt tomato"></i>';
            }
        }
        
        // Bắt đầu phiên Pomodoro mới
        function startPomodoroSession() {
            // Lấy dữ liệu từ form
            const formData = new FormData(document.getElementById('pomodoro-settings-form'));
            
            // Gửi yêu cầu AJAX để bắt đầu phiên mới
            fetch('{% url "advanced_learning:pomodoro_start" %}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    sessionId = data.session_id;
                    console.log('Phiên Pomodoro mới đã bắt đầu:', data);
                }
            })
            .catch(error => {
                console.error('Lỗi khi bắt đầu phiên Pomodoro:', error);
            });
        }
        
        // Kết thúc phiên Pomodoro
        function endPomodoroSession() {
            if (!sessionId) return;
            
            // Tạo FormData
            const formData = new FormData();
            formData.append('session_id', sessionId);
            formData.append('completed_pomodoros', completedPomodoros);
            
            // Thêm CSRF token
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            
            // Gửi yêu cầu AJAX để kết thúc phiên
            fetch('{% url "advanced_learning:pomodoro_end" %}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': csrfToken
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('Phiên Pomodoro đã kết thúc:', data);
                    sessionId = null;
                    completedPomodoros = 0;
                    pomodoroCount.textContent = '0';
                    pomodoroIcons.innerHTML = '';
                }
            })
            .catch(error => {
                console.error('Lỗi khi kết thúc phiên Pomodoro:', error);
            });
        }
        
        // Xử lý sự kiện cho các nút
        startBtn.addEventListener('click', startTimer);
        pauseBtn.addEventListener('click', pauseTimer);
        resumeBtn.addEventListener('click', resumeTimer);
        resetBtn.addEventListener('click', resetTimer);
        skipBtn.addEventListener('click', skipPhase);
        
        // Xử lý sự kiện khi thay đổi chủ đề
        document.getElementById('subject').addEventListener('change', function() {
            const subjectId = this.value;
            const topicSelect = document.getElementById('topic');
            
            if (subjectId) {
                // Kích hoạt select topic
                topicSelect.disabled = false;
                
                // Gửi yêu cầu AJAX để lấy danh sách topic
                fetch(`/api/subjects/${subjectId}/topics/`)
                    .then(response => response.json())
                    .then(data => {
                        // Xóa các option cũ
                        topicSelect.innerHTML = '<option value="">-- Chọn chủ đề con --</option>';
                        
                        // Thêm các option mới
                        data.forEach(topic => {
                            const option = document.createElement('option');
                            option.value = topic.id;
                            option.textContent = topic.name;
                            topicSelect.appendChild(option);
                        });
                    })
                    .catch(error => {
                        console.error('Lỗi khi lấy danh sách chủ đề con:', error);
                    });
            } else {
                // Vô hiệu hóa select topic
                topicSelect.disabled = true;
                topicSelect.innerHTML = '<option value="">-- Chọn chủ đề trước --</option>';
            }
        });
        
        // Khởi tạo timer
        updateTimerDisplay();
    });
</script>
{% endblock %}
